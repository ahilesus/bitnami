{{- $services := list -}}
{{- range .Values.global.services }}
{{- if .vault }}
  {{- $services = append $services . }}
{{- end }}
{{- end }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: policy-configmap
  namespace: {{ .Release.Namespace }}
data:
  hzp-certificate-svc: |-
    # policy for PKI
    path "pki/eo/*" {
      capabilities = ["create", "read", "update", "list", "patch", "delete"]
    }

    # policy for KV
    path "kv/eo/hzp-certificate-svc/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    # policy for KV
    path "kv/m2m/hzp-certificate-svc/*" {
      capabilities = ["read", "list"]
    }

  hzp-recovery-svc: |-
    # policy for PKI
    path "pki/eo/*" {
      capabilities = ["create", "read", "update", "list"]
    }

    # policy for KV
    path "kv/eo/hzp-recovery-svc/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

  hzp-fido-onboarding-svc: |-
    # policy for KV
    path "kv/eo/hzp-fido-onboarding-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }

  hzp-eo-initialization-svc: |-
    # policy for KV
    path "kv/eo/hzp-eo-initialization-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }  

  hzp-fru-svc: |-
    # policy for KV
    path "kv/eo/hzp-fru-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }  

  hzp-inventory-svc: |-
    # policy for KV
    path "kv/eo/hzp-inventory-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }  

    # policy for M2M
    path "kv/m2m/hzp-inventory-svc/*" {
      capabilities = ["read", "list"]
    }

  mist: |-
    # policy to create KV
    path "sys/mounts/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    path "secret/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    # policy to create policy
    path "sys/policy/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    # policy to create approle
    path "auth/approle/role/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    # policy to create system
    path "system/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    # policy for M2M
    path "kv/m2m/mist/*" {
      capabilities = ["read", "list"]
    }
    
  fido-owner: |-
    # policy for PKI
    path "pki/eo/*" {
      capabilities = ["create", "read", "update", "list"]
    }

  spire: |-
    # policy for PKI
    path "pki/eo/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }
    
  hzp-upgrade-svc: |-
    # policy for KV
    path "kv/eo/hzp-upgrade-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }
    
  hzp-catalog-svc: |-
    # policy for KV
    path "kv/eo/hzp-catalog-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }

  fusion-svc: |-
    # policy for KV
    path "kv/eo/fusion-svc/*" {
      capabilities = ["read", "list", "create", "update", "patch", "delete"]
    }

  {{- range $services}}
  {{ .name }}: |-
    # policy for PKI
    path "kv/m2m/{{ .name }}/*" {
      capabilities = ["read", "list"]
    }
    {{- if .vaultPolicies }}
      {{ .vaultPolicies | indent 4 }}
    {{- end }}
  {{- end }}
